#!/bin/bash
# MemoryOS CLI -- manage the MemoryOS background services
# Usage: ./scripts/memoryos <command>
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"
VENV_PYTHON="$REPO_DIR/.venv/bin/python3"
AGENTS_DIR="$HOME/Library/LaunchAgents"
LABEL_PREFIX="com.memoryos"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BOLD='\033[1m'
NC='\033[0m'

# ── Helpers ──────────────────────────────────────────────────────────────────

usage() {
    echo "MemoryOS CLI"
    echo ""
    echo "Usage: memoryos <command>"
    echo ""
    echo "Commands:"
    echo "  start       Load all launchd agents and start the dashboard"
    echo "  stop        Unload all launchd agents and stop the dashboard"
    echo "  restart     Stop then start all agents"
    echo "  status      Show running agents and dashboard health"
    echo "  doctor      Full health check (deps, permissions, connectivity)"
    echo "  logs        Tail the combined MemoryOS log"
    echo "  update      Pull latest code and reinstall dependencies"
    echo "  uninstall   Remove all launchd agents and clean up"
    echo ""
}

count_agents() {
    launchctl list 2>/dev/null | grep -c "$LABEL_PREFIX" || echo "0"
}

# ── Commands ─────────────────────────────────────────────────────────────────

cmd_start() {
    echo -e "${BOLD}Starting MemoryOS...${NC}"
    echo ""

    local loaded=0
    for plist in "$AGENTS_DIR"/${LABEL_PREFIX}.*.plist; do
        [[ -f "$plist" ]] || continue
        name=$(basename "$plist" .plist)
        if launchctl list "$name" &>/dev/null; then
            echo -e "  ${GREEN}✓${NC} $name (already running)"
        else
            launchctl load "$plist" 2>/dev/null && \
                echo -e "  ${GREEN}✓${NC} $name (started)" || \
                echo -e "  ${RED}✗${NC} $name (failed to start)"
        fi
        loaded=$((loaded + 1))
    done

    if [[ $loaded -eq 0 ]]; then
        echo -e "  ${YELLOW}⚠${NC} No agents installed. Run the Setup Wizard first:"
        echo "    open http://localhost:8765"
        echo ""
        echo "  Or install agents manually:"
        echo "    ./scripts/install_launchd.sh"
        return
    fi

    echo ""
    echo -e "  ${GREEN}$loaded agents loaded.${NC}"

    # Check dashboard
    sleep 1
    if curl -sf http://localhost:8765/api/status &>/dev/null; then
        echo -e "  Dashboard: ${GREEN}http://localhost:8765${NC}"
    else
        echo -e "  Dashboard: ${YELLOW}starting up...${NC} (check in a few seconds)"
    fi
    echo ""
}

cmd_stop() {
    echo -e "${BOLD}Stopping MemoryOS...${NC}"
    echo ""

    local stopped=0
    for plist in "$AGENTS_DIR"/${LABEL_PREFIX}.*.plist; do
        [[ -f "$plist" ]] || continue
        name=$(basename "$plist" .plist)
        launchctl unload "$plist" 2>/dev/null && \
            echo -e "  ${GREEN}✓${NC} $name (stopped)" || \
            echo -e "  ${YELLOW}⚠${NC} $name (was not running)"
        stopped=$((stopped + 1))
    done

    # Kill any remaining dashboard process
    pkill -f "src/dashboard/app.py" 2>/dev/null || true

    echo ""
    echo -e "  ${GREEN}$stopped agents unloaded.${NC}"
    echo ""
}

cmd_restart() {
    cmd_stop
    sleep 1
    cmd_start
}

cmd_status() {
    echo -e "${BOLD}MemoryOS Status${NC}"
    echo ""

    # Agents
    echo -e "  ${BOLD}Agents:${NC}"
    local running=0
    local total=0
    for plist in "$AGENTS_DIR"/${LABEL_PREFIX}.*.plist; do
        [[ -f "$plist" ]] || continue
        total=$((total + 1))
        name=$(basename "$plist" .plist)
        short="${name#com.memoryos.}"
        if launchctl list "$name" &>/dev/null; then
            pid=$(launchctl list "$name" 2>/dev/null | awk 'NR>1{print $1}')
            echo -e "    ${GREEN}●${NC} $short ${YELLOW}(PID ${pid:-?})${NC}"
            running=$((running + 1))
        else
            echo -e "    ${RED}○${NC} $short (stopped)"
        fi
    done

    if [[ $total -eq 0 ]]; then
        echo -e "    ${YELLOW}No agents installed.${NC}"
    else
        echo ""
        echo -e "  $running/$total agents running"
    fi

    # Dashboard
    echo ""
    echo -e "  ${BOLD}Dashboard:${NC}"
    if curl -sf http://localhost:8765/api/status &>/dev/null; then
        echo -e "    ${GREEN}●${NC} Running at http://localhost:8765"
    else
        echo -e "    ${RED}○${NC} Not reachable"
    fi

    # Screenpipe
    echo ""
    echo -e "  ${BOLD}Screenpipe:${NC}"
    if curl -sf http://localhost:3030/health &>/dev/null; then
        echo -e "    ${GREEN}●${NC} Running"
    elif [[ -d "$HOME/.screenpipe" ]]; then
        echo -e "    ${YELLOW}○${NC} Installed but not running"
    else
        echo -e "    ${RED}○${NC} Not installed"
    fi

    echo ""
}

cmd_doctor() {
    echo -e "${BOLD}MemoryOS Health Check${NC}"
    echo ""
    local issues=0

    # macOS version
    MACOS_VER=$(sw_vers -productVersion 2>/dev/null || echo "unknown")
    echo -e "  macOS:          $MACOS_VER"

    # Python
    if [[ -x "$VENV_PYTHON" ]]; then
        PY_VER=$("$VENV_PYTHON" -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}")')
        echo -e "  Python:         ${GREEN}$PY_VER${NC}"
    else
        echo -e "  Python venv:    ${RED}not found${NC} -- run ./install.sh"
        issues=$((issues + 1))
    fi

    # Homebrew
    if command -v brew &>/dev/null; then
        echo -e "  Homebrew:       ${GREEN}installed${NC}"
    else
        echo -e "  Homebrew:       ${RED}not found${NC}"
        issues=$((issues + 1))
    fi

    # pandoc
    if command -v pandoc &>/dev/null; then
        echo -e "  pandoc:         ${GREEN}installed${NC}"
    else
        echo -e "  pandoc:         ${RED}not found${NC} -- brew install pandoc"
        issues=$((issues + 1))
    fi

    # BlackHole
    if brew list blackhole-2ch &>/dev/null 2>&1; then
        echo -e "  BlackHole 2ch:  ${GREEN}installed${NC}"
    else
        echo -e "  BlackHole 2ch:  ${YELLOW}not installed${NC} (optional -- brew install blackhole-2ch)"
    fi

    # Config
    if [[ -f "$REPO_DIR/config/config.yaml" ]]; then
        echo -e "  config.yaml:    ${GREEN}exists${NC}"
    else
        echo -e "  config.yaml:    ${RED}missing${NC} -- run ./install.sh"
        issues=$((issues + 1))
    fi

    # .env.local
    if [[ -f "$REPO_DIR/.env.local" ]]; then
        echo -e "  .env.local:     ${GREEN}exists${NC}"
    else
        echo -e "  .env.local:     ${YELLOW}missing${NC} -- cp .env.example .env.local"
    fi

    # Full Disk Access
    echo ""
    echo -e "  ${BOLD}Permissions:${NC}"
    if python3 -c "import os; os.listdir('$HOME/Library/Mail')" 2>/dev/null; then
        echo -e "  Full Disk:      ${GREEN}granted${NC}"
    else
        echo -e "  Full Disk:      ${RED}not granted${NC} -- run ./scripts/grant_permissions.sh"
        issues=$((issues + 1))
    fi

    # Screenpipe
    echo ""
    echo -e "  ${BOLD}Services:${NC}"
    if curl -sf http://localhost:3030/health &>/dev/null; then
        echo -e "  Screenpipe:     ${GREEN}running${NC}"
    elif [[ -d "$HOME/.screenpipe" ]]; then
        echo -e "  Screenpipe:     ${YELLOW}installed but not running${NC}"
    else
        echo -e "  Screenpipe:     ${YELLOW}not installed${NC} (optional -- screenpipe.com)"
    fi

    if curl -sf http://localhost:8765/api/status &>/dev/null; then
        echo -e "  Dashboard:      ${GREEN}running${NC}"
    else
        echo -e "  Dashboard:      ${RED}not running${NC}"
        issues=$((issues + 1))
    fi

    # Agents
    local agent_count
    agent_count=$(count_agents)
    echo -e "  Agents:         $agent_count loaded"

    # Summary
    echo ""
    if [[ $issues -eq 0 ]]; then
        echo -e "  ${GREEN}All checks passed.${NC}"
    else
        echo -e "  ${YELLOW}$issues issue(s) found.${NC}"
    fi
    echo ""
}

cmd_logs() {
    local target="${1:-}"
    if [[ -n "$target" ]]; then
        local logfile="$REPO_DIR/logs/${target}_launchd.log"
        local errfile="$REPO_DIR/logs/${target}_launchd.err"
        if [[ -f "$logfile" ]]; then
            tail -f "$logfile" "$errfile" 2>/dev/null
        else
            echo "No log file found for '$target'"
            echo "Available logs:"
            ls "$REPO_DIR/logs/"*.log 2>/dev/null | xargs -I{} basename {} | sed 's/^/  /'
        fi
    else
        tail -f "$REPO_DIR/logs/memoryos.log" 2>/dev/null || \
            echo "No log file found. Logs are in: $REPO_DIR/logs/"
    fi
}

cmd_update() {
    echo -e "${BOLD}Updating MemoryOS...${NC}"
    echo ""

    echo "  Pulling latest code..."
    cd "$REPO_DIR"
    git pull || { echo -e "  ${RED}git pull failed${NC}"; return 1; }

    echo "  Updating Python dependencies..."
    source "$REPO_DIR/.venv/bin/activate"
    pip install -r "$REPO_DIR/requirements.txt" --quiet

    echo "  Reinstalling agents..."
    "$SCRIPT_DIR/install_launchd.sh"

    echo ""
    echo -e "  ${GREEN}Update complete.${NC}"
    echo ""
}

cmd_uninstall() {
    echo -e "${BOLD}Uninstall MemoryOS${NC}"
    echo ""
    echo "  This will:"
    echo "    1. Stop and remove all launchd agents"
    echo "    2. Remove plist files from ~/Library/LaunchAgents/"
    echo ""
    echo "  It will NOT delete:"
    echo "    - Your Obsidian vault data"
    echo "    - The MemoryOS repo folder"
    echo "    - System tools (Python, Homebrew, pandoc)"
    echo ""
    read -rp "  Continue? [y/N] " confirm
    if [[ "${confirm,,}" != "y" ]]; then
        echo "  Cancelled."
        return
    fi

    echo ""
    for plist in "$AGENTS_DIR"/${LABEL_PREFIX}.*.plist; do
        [[ -f "$plist" ]] || continue
        name=$(basename "$plist" .plist)
        launchctl unload "$plist" 2>/dev/null || true
        rm -f "$plist"
        echo -e "  ${GREEN}✓${NC} Removed $name"
    done

    pkill -f "src/dashboard/app.py" 2>/dev/null || true

    echo ""
    echo -e "  ${GREEN}All agents removed.${NC}"
    echo ""
    echo "  To fully remove MemoryOS, delete the repo folder:"
    echo "    rm -rf $REPO_DIR"
    echo ""
    echo "  To reinstall later:"
    echo "    ./install.sh"
    echo ""
}

# ── Main ─────────────────────────────────────────────────────────────────────

CMD="${1:-}"
shift 2>/dev/null || true

case "$CMD" in
    start)      cmd_start ;;
    stop)       cmd_stop ;;
    restart)    cmd_restart ;;
    status)     cmd_status ;;
    doctor)     cmd_doctor ;;
    logs)       cmd_logs "$@" ;;
    update)     cmd_update ;;
    uninstall)  cmd_uninstall ;;
    help|--help|-h)  usage ;;
    *)
        if [[ -n "$CMD" ]]; then
            echo "Unknown command: $CMD"
            echo ""
        fi
        usage
        exit 1
        ;;
esac
